<html>

<head>
    <script type="text/javascript" src="js/heatmap.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/d3.min.js"></script>
    <title>Compusystems - Heatmapping</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    </style>
</head>

<body>
    <div id="header">
        <div class="left padd30">
            Heatmapping - Expo Hall
        </div>
        <div class="right padd30">
            GreenBuild 2015
        </div>
    </div>
    <div id="content">
        <div id="stage"></div>
        <div id="exhibitorList"></div>
    </div>
</body>
<script>

        var hallName = "Expo Hall";

    var margin = {
            top: -5,
            right: -5,
            bottom: -5,
            left: -5
        },
        width = 1000 - margin.left - margin.right,
        height = 1000 - margin.top - margin.bottom;

    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 15])
        .on("zoom", zoomed);

    var drag = d3.behavior.drag()
        .origin(function(d) {
            return d;
        })
        .on("dragstart", dragstarted)
        .on("drag", dragged)
        .on("dragend", dragended);

    var svg = d3.select("#stage").append("svg")
        .attr("width", "100%")
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        // .attr("transform", "translate(" + margin.left + "," + margin.right + ")")
        .attr("transform", "translate(200,-500)")
        .call(zoom);

    var rect = svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all");

    var container = svg.append("g");

    container.append("g")
        .attr("class", "x axis")
        .selectAll("line")
        .data(d3.range(0, width, 10))
        .enter().append("line")
        .attr("x1", function(d) {
            return d;
        })
        .attr("y1", 0)
        .attr("x2", function(d) {
            return d;
        })
        .attr("y2", height);

    container.append("g")
        .attr("class", "y axis")
        .selectAll("line")
        .data(d3.range(0, height, 10))
        .enter().append("line")
        .attr("x1", 0)
        .attr("y1", function(d) {
            return d;
        })
        .attr("x2", width)
        .attr("y2", function(d) {
            return d;
        });

    function dottype(d) {
        d.x = +d.x;
        d.y = +d.y;
        return d;
    }

    function zoomed() {
        container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

    function dragstarted(d) {
        d3.event.sourceEvent.stopPropagation();
        d3.select(this).classed("dragging", true);
    }

    function dragged(d) {
        d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
    }

    function dragended(d) {
        d3.select(this).classed("dragging", false);
    }

            function drawBooths(){
            // Run an ajax call to the MAPS JSON to get the booth data
            $.get("https://www.compusystems.com/mobile/935/maps/DynamicMapsJson.json", function (data){                 
                
                // Iterate through the JSON data based on the content length
                var length  = data[hallName].length;


                var lineGraph = container.append("image")
                                .attr("xlink:href", "map.jpg")
                                .attr("x", 0)
                                .attr("y", 0)
                                .attr("width",1000)
                                .attr("height",1500);
                                
                for (var i=0;i < length; i++){
        
                    // Get the number of corners for the booth
                    var cor_length = data[hallName][i].CORNERS.length;
        
        
                    var vertices = new Array(cor_length * 2); // Setting up vertices
                    
                    for (var j=0,index = 0;j < cor_length; j++,index = index+2){
                        vertices[index] = data[hallName][i].CORNERS[j].X; // Add vertices X to the array
                        vertices[index+1] = (data[hallName][i].CORNERS[j].Y) ; // Add vertices Y to the array
                    }

                        var lineGraph = container.append("polygon")
                        .attr("stroke", "#aaaaee")
                        .attr("stroke-width", 0.1)
                        .attr("fill", "#eeeeff")
                        .attr("points", vertices);

                        // var lineLabel = container.append("text")         // append text
                        //     .style("fill", "black")
                        //     .attr("x", (vertices[0]+vertices[2])/2)           // set x position of left side of text
                        //     .attr("y", (vertices[1]+vertices[5])/2)           // set y position of bottom of text
                        //     .attr("text-anchor", "middle")  // set anchor y justification 
                        //     .text(data[hallName][i].BOOTH)
                        //     .style("font-size", function(d) { return Math.min(2 * 2, (2 * 2 - 8) / this.getComputedTextLength() * 24) + "px"})
                        //     ; 

                        text = container.append('foreignObject')
                        .attr('x', vertices[0])
                        .attr('y', vertices[1])
                        .attr('width', Math.abs(vertices[0]-vertices[2]))
                        .attr('height', Math.abs(vertices[1]-vertices[5]))
                        .append("xhtml:body")
                        .html('<div style="font-size:1px;padding:0.2px;line-height:2px">Booth:'+ data[hallName][i].BOOTH + '<br/>' + data[hallName][i].COMPANY +'</div>')
                }
            
            })
        }


        $(document).ready(function(){ 
            startDrawing(); 
        });

        function startDrawing() {

                            
            drawBooths();
            
        }

        function getSize(d) {
            var bbox = this.getBBox(),
            cbbox = this.parentNode.getBBox(),
            scale = Math.min(cbbox.width/bbox.width, cbbox.height/bbox.height);
            d = scale;
            console.log((d/10) + "px");
            // d3.select(this).style("font-size",d + "px");
        }

        function wrap(text, width) {
          text.each(function() {
            var text = d3.select(this),
                words = text.text().split(/\s+/).reverse(),
                word,
                line = [],
                lineNumber = 0,
                lineHeight = 1.1, // ems
                y = text.attr("y"),
                dy = parseFloat(text.attr("dy")),
                tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
            while (word = words.pop()) {
              line.push(word);
              tspan.text(line.join(" "));
              if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));
                line = [word];
                tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
              }
            }
          });
        }

        function type(d) {
          d.value = +d.value;
          return d;
        }
</script>

</html>
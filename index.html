<html>
<head>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/d3.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Compusystems - Heatmapping</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
</head>

<body>

<div id="legend">
    <div class="txtcenter smalltext">Legend</div>


    <div id="controls">
        <table id="tablecontrol" class="full-width">
            <tr><td id="zoom_in" class="txtcenter control border-right">+</td><td onclick="zoomOut()" class="txtcenter control border-right">-</td><td onclick="startPlay()" class="txtcenter control">&#9658;</td></tr>
        </table>
    </div>
</div>
<div id="header">
    <div class="left padd30">
        Heatmapping - Expo Hall (GreenBuild 2015)
    </div>
    <div class="right padd30">
    </div>
</div>

<div id="content">
    <div id="stage"></div>
    <div id="exhibitorList"></div>
</div>

<div id="footer">
    <table id="sliderTable" class="fulltable hidden">
        <tr>
            <td>
                <div id="time-range">
                    <p><span id="messageArea">- - - Loading - - </span><span class="slider-time"></span> - <span
                            class="slider-time2"></span>
                    </p>

                    <div class="sliders_step1">
                        <div id="slider-range"></div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <table id="showTimeTable" class="fullTable">
    </table>
    <table id="showDaysTable" class="fullTable">
    </table>
</div>
</body>
<script>
    var hallName = "Expo Hall";
    var currentDay = 0;
    var currentMinTime = 0;
    var currentMaxTime = 0;
    var hoursCount = 0;
    var currentHourCount = 0;
    var maxVisits;

    var margin = {
                top: -5,
                right: -5,
                bottom: -5,
                left: -5
            },
            width = 1000 - margin.left - margin.right,
            height = 1000 - margin.top - margin.bottom;

    var zoom = d3.behavior.zoom()
            .scaleExtent([1, 15])
            .on("zoom", zoomed);

    var drag = d3.behavior.drag()
            .origin(function (d) {
                return d;
            })
            .on("dragstart", dragstarted)
            .on("drag", dragged)
            .on("dragend", dragended);

    var svg = d3.select("#stage").append("svg")
            .attr("width", "100%")
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("id", "mapContainer")
            // .attr("transform", "translate(" + margin.left + "," + margin.right + ")")
            .attr("transform", "translate(200,-500)")
            .call(zoom);

    var rect = svg.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "none")
            .style("pointer-events", "all");

    var container = svg.append("g");

    function dottype(d) {
        d.x = +d.x;
        d.y = +d.y;
        return d;
    }

    function zoomed() {
        container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

    function zoomClick() {
        var clicked = d3.event.target,
                direction = 1,
                factor = 0.2,
                target_zoom = 1,
                center = [width / 2, height / 2],
                extent = zoom.scaleExtent(),
                translate = zoom.translate(),
                translate0 = [],
                l = [],
                view = {x: translate[0], y: translate[1], k: zoom.scale()};

        d3.event.preventDefault();
        direction = (this.id === 'zoom_in') ? 1 : -1;
        target_zoom = zoom.scale() * (1 + factor * direction);

        if (target_zoom < extent[0] || target_zoom > extent[1]) { return false; }

        translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
        view.k = target_zoom;
        l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

        view.x += center[0] - l[0];
        view.y += center[1] - l[1];

        interpolateZoom([view.x, view.y], view.k);
    }


    function dragstarted(d) {
        d3.event.sourceEvent.stopPropagation();
        d3.select(this).classed("dragging", true);
    }

    function dragged(d) {
        d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
    }

    function dragended(d) {
        d3.select(this).classed("dragging", false);
    }

    generateDateline();

    function drawBooths() {
        // Run an ajax call to the MAPS JSON to get the booth data
        d3.json("DynamicMapsJson.json", function (error, data) {

            // Iterate through the JSON data based on the content length
            var length = data[hallName].length;


            var lineGraph = container.append("image")
                    .attr("xlink:href", "map.jpg")
                    .attr("id", "mapImage")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 1000)
                    .attr("height", 1500);

            for (var i = 0; i < length; i++) {
                var cor_length = data[hallName][i].CORNERS.length;

                var vertices = new Array(cor_length * 2); // Setting up vertices

                for (var j = 0, index = 0; j < cor_length; j++, index = index + 2) {
                    vertices[index] = data[hallName][i].CORNERS[j].X; // Add vertices X to the array
                    vertices[index + 1] = (data[hallName][i].CORNERS[j].Y); // Add vertices Y to the array
                }

                var lineGraph = container.append("polygon")
                        .attr("stroke", "#aaaaee")
                        .attr("stroke-width", 0.1)
                        .attr("fill", "#eeeeff")
                        .attr("points", vertices);

            }

            generateHeatMap();


            for (var i = 0; i < length; i++) {

                var minX, minY;
                var maxX, maxY;

                for (var j = 0, index = 0; j < cor_length; j++, index = index + 2) {

                    if (minX == undefined || minX > data[hallName][i].CORNERS[j].X) {
                        minX = data[hallName][i].CORNERS[j].X
                    }
                    if (minY == undefined || minY > data[hallName][i].CORNERS[j].Y) {
                        minY = data[hallName][i].CORNERS[j].Y
                    }
                    if (maxX == undefined || maxX < data[hallName][i].CORNERS[j].X) {
                        maxX = data[hallName][i].CORNERS[j].X
                    }
                    if (maxY == undefined || maxY < data[hallName][i].CORNERS[j].Y) {
                        maxY = data[hallName][i].CORNERS[j].Y
                    }

                }

                var boothTitle = 'Booth:' + data[hallName][i].BOOTH + " " + data[hallName][i].COMPANY;
                text = container.append('foreignObject')
                        .attr('x', minX)
                        .attr('y', function (d) {
                            if (boothTitle.length < (maxX - minX) * 2) return (minY + maxY) / 2; else return minY;
                        })
                        .attr('width', Math.abs(maxX - minX))
                        .attr('height', Math.abs(maxY - minY))
                        .style('text-align', "center")
                        .classed('wordwrap', true)
                        .attr('font-size', '0.8px')
                        .text(boothTitle);


                minX = undefined;
                minY = undefined;
                maxX = undefined;
                maxY = undefined;
            }
        })
    }


    $(document).ready(function () {
        loadData();
    });

    function loadData(){
        loadMapsJSON();
    }

    function loadHeatMapJSON(){
        d3.json("heatmap.json", function(data) {
            startDrawing();
            startPlay();
        });
    }

    function loadMapsJSON(){
        d3.json("DynamicMapsJson.json", function(data) {
            loadHeatMapJSON();
        });
    }

    function startDrawing() {
        $("#messageArea").html("Time range : ");

        $('.slider-time').html("Select Date");
        $('.slider-time2').html("From Below");
        drawBooths();
    }


    function setDate(day, className, value) {
        currentDay = day;
        generateDateline();
    }

    function setColorToId(className, value) {
        d3.selectAll("." + className).style("background", "");
        d3.select("#" + className + value).style("background", "#00FFFF");
    }

    function generateDateline() {
        d3.select("#showDaysTable").html("");

        $("#sliderTable").show();

        d3.json("heatmap.json", function (error, json) {
            if (error) return console.warn(error);

            var showDays = json.showDays;
            var interval = json.interval;

            showDays.forEach(function (d) {
                var startDay = new Date(d.startDateTime);
                var format = d3.time.format("%B %d");

                d3.select("#showDaysTable")
                        .append("td")
                        .attr("id", "day" + startDay.getDay())
                        .classed("day", true)
                        .attr("onClick", "setDate(" + startDay.getDay() + ",'day'," + startDay.getDay() + ")")
                        .append("span")
                        .html(format(startDay));

                if (startDay.getDay() == currentDay) {
                    generateTimeLine(d.startDateTime, d.endDateTime,interval);
                    setColorToId("day", startDay.getDay());
                }
            });
        });
    }

    function generateTimeLine(startTime, endTime, currentHourCount) {
        console.log("Generated Timeline");

        // d3.select("#showTimeTable").html("<td><span id='startTime'>" + startHour + "</span></td><td><input type='range' oninput='setHour(this.value)' onchange='setHour(this.value)' step='1' id='timeRange' min='"+ startHour + "'' max='" + endHour +"'></td><td><span id='endTime'>" + endHour + "</span></td>");

        currentMinTime = startTime;
        currentMaxTime = endTime;

        generateHeatMap();

        updateTimeRange();


        d3.select("#showTimeTable").html("");
        for (var i = startTime; i <= endTime; i=i+3600000) {
            var iteratedDate = new Date(i);
            d3.select("#showTimeTable")
                    .append("td")
                    .classed("time", true)
                    .append("span")
                    .html(getFormattedTime(iteratedDate.getHours(),iteratedDate.getMinutes()));
            hoursCount++;
        }

        $("#slider-range").slider({
            range: true,
            min: startTime,
            max: endTime,
            step: 1,
            values: [startTime + (currentHourCount * 3600000), startTime + ((currentHourCount * 3600000) + 3600000)],
            slide: function (e, ui) {

                currentMinTime = ui.values[0];
                currentMaxTime = ui.values[1];

                generateHeatMap();

                updateTimeRange();
            }
        });

    }

    function generateHeatMap() {

        d3.selectAll(".heatMapObject").remove();

        d3.json("heatmap.json", function (error, json) {
            if (error) return console.warn(error);
            var heatMapData = json.heatMap;
            maxVisits = json.max;

            heatMapData.forEach(function (d) {
                var visitStartTime = new Date(d.visitStartTime);
                var visitEndTime = new Date(d.visitEndTime);
                var coordinates = d.coordinates[0];
                var color = "#00FF00";

                if (visitStartTime >= currentMinTime && visitStartTime < currentMaxTime && visitStartTime.getDay() == currentDay) {

                    if(coordinates.visits > (0.75 * maxVisits)){
                        color = "#FF0000";
                    } else if(coordinates.visits < (0.75 * maxVisits) && coordinates.visits > (0.25 * maxVisits)) {

                    } else if(coordinates.visits < (0.25 * maxVisits)){
                        color = "#0000FF";
                    }

                    container.append("g")
                            .classed("heatMapObject",true)
                            .append("circle")
                            .attr("cx", coordinates.X)
                            .attr("cy", coordinates.Y)
//                            .attr("r", 0.5 * coordinates.visits)
                            .attr("r", 5)
                            .attr("fill-opacity", "0.03")
                            .style("fill", color);

                } else {
                    // console.log("NOT THERE->visitDay : " + visitStartTime.getDay() + "visitStartTime : " + visitStartTime.getHours());
                }
            });
        });
    }

    function updateTimeRange() {
        var currentMinHour = new Date(currentMinTime);
        var currentMaxHour = new Date(currentMaxTime);

        $('.slider-time').html(getFormattedTime(currentMinHour.getHours(),currentMinHour.getMinutes()));
        $('.slider-time2').html(getFormattedTime(currentMaxHour.getHours(),currentMaxHour.getMinutes()));
    }

    function getFormattedTime(hourOfTheDay,mins){
        var displayedHour = 0;

        if (hourOfTheDay > 0 && hourOfTheDay <= 12) {
            displayedHour = getPluralTime(hourOfTheDay);
            if(mins != null){
                displayedHour = displayedHour + ":" + getPluralTime(mins);
            }
            return displayedHour + " AM";
        } else {
            if (hourOfTheDay == 24 || hourOfTheDay == 0) {
                displayedHour = "00";
                if(mins != null){
                    displayedHour = displayedHour + ":" + getPluralTime(mins);
                }
                return displayedHour + " AM";
            } else {
                var absoluteHour = Math.abs(12-hourOfTheDay).toString();
                displayedHour = getPluralTime(absoluteHour);
                if(mins != null){
                    displayedHour = displayedHour + ":" + getPluralTime(mins);
                }
                return displayedHour + " PM";
            }
        }
    }

    function getPluralTime(timeValue){
        if(timeValue.toString().length == 1){
            return "0" + timeValue;
        } else {
            return timeValue;
        }
    }

    function startPlay(){
        console.log("Running this for : " +  currentHourCount);
//        setTimeout(startPlay, 4000);
//        generateTimeLine(currentMinTime,currentMaxTime,currentHourCount);
//        currentHourCount++;
    }
</script>
</html>